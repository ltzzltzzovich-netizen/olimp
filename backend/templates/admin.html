<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
        .header { background: linear-gradient(135deg, #1565C0, #1976D2); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 24px; }
        .header-actions { display: flex; gap: 10px; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; }
        .btn-primary { background: #2196F3; color: white; }
        .btn-success { background: #4CAF50; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-warning { background: #ff9800; color: white; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        
        .tabs { display: flex; background: white; border-bottom: 2px solid #e0e0e0; }
        .tab { padding: 15px 30px; cursor: pointer; border: none; background: none; font-size: 16px; color: #666; border-bottom: 3px solid transparent; margin-bottom: -2px; }
        .tab.active { color: #1976D2; border-bottom-color: #1976D2; font-weight: 600; }
        .tab:hover { background: #f5f5f5; }
        
        .content { padding: 20px; max-width: 1400px; margin: 0 auto; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .search { padding: 10px 15px; border: 1px solid #ddd; border-radius: 6px; width: 300px; }
        
        table { width: 100%; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 600; color: #333; }
        tr:hover { background: #f5f9ff; }
        
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; }
        .badge-worker { background: #e3f2fd; color: #1565c0; }
        .badge-master { background: #fff3e0; color: #e65100; }
        .badge-dispatcher { background: #f3e5f5; color: #7b1fa2; }
        .badge-new { background: #e3f2fd; color: #1565c0; }
        .badge-assigned { background: #e8f5e9; color: #2e7d32; }
        .badge-inprogress { background: #fff3e0; color: #e65100; }
        .badge-completed { background: #e8f5e9; color: #2e7d32; }
        .badge-denied { background: #ffebee; color: #c62828; }
        
        .actions { display: flex; gap: 5px; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal.show { display: flex; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 500px; max-width: 90%; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { font-size: 20px; }
        .close { font-size: 28px; cursor: pointer; color: #999; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: #333; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .form-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        
        .status-msg { padding: 15px; margin: 10px 0; border-radius: 6px; display: none; }
        .status-msg.success { display: block; background: #e8f5e9; color: #2e7d32; }
        .status-msg.error { display: block; background: #ffebee; color: #c62828; }
        
        .danger-zone { background: #fff5f5; border: 1px solid #ffcdd2; padding: 20px; border-radius: 8px; margin-top: 30px; }
        .danger-zone h3 { color: #c62828; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîß –ü–∞–Ω–µ–ª—å –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>
        <div class="header-actions">
            <a href="/reports/export" class="btn btn-success">üì• –°–∫–∞—á–∞—Ç—å Excel</a>
        </div>
    </div>
    
    <div class="tabs">
        <button class="tab active" data-tab="users">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
        <button class="tab" data-tab="equipment">üîß –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</button>
        <button class="tab" data-tab="requests">üìã –ó–∞—è–≤–∫–∏</button>
    </div>
    
    <div class="content">
        <div id="status-msg" class="status-msg"></div>
        
        <!-- Users Tab -->
        <div id="users" class="tab-content active">
            <div class="toolbar">
                <input type="text" class="search" placeholder="–ü–æ–∏—Å–∫..." onkeyup="filterTable('users-table', this.value)">
                <button class="btn btn-primary" onclick="openModal('user')">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
            </div>
            <table id="users-table">
                <thead>
                    <tr><th>ID</th><th>–õ–æ–≥–∏–Ω</th><th>–ò–º—è</th><th>–†–æ–ª—å</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        
        <!-- Equipment Tab -->
        <div id="equipment" class="tab-content">
            <div class="toolbar">
                <input type="text" class="search" placeholder="–ü–æ–∏—Å–∫..." onkeyup="filterTable('equipment-table', this.value)">
                <button class="btn btn-primary" onclick="openModal('equipment')">‚ûï –î–æ–±–∞–≤–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</button>
            </div>
            <table id="equipment-table">
                <thead>
                    <tr><th>ID</th><th>–ö–æ–¥</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–¶–µ—Ö</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        
        <!-- Requests Tab -->
        <div id="requests" class="tab-content">
            <div class="toolbar">
                <input type="text" class="search" placeholder="–ü–æ–∏—Å–∫..." onkeyup="filterTable('requests-table', this.value)">
                <div>
                    <button class="btn btn-danger" onclick="if(confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï –∑–∞—è–≤–∫–∏?')) resetRequests()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ</button>
                </div>
            </div>
            <table id="requests-table">
                <thead>
                    <tr><th>ID</th><th>–î–∞—Ç–∞</th><th>–ê–≤—Ç–æ—Ä</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th><th>–ú–∞—Å—Ç–µ—Ä</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    
    <!-- User Modal -->
    <div id="user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="user-modal-title">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
                <span class="close" onclick="closeModal('user')">&times;</span>
            </div>
            <form id="user-form" onsubmit="saveUser(event)">
                <input type="hidden" id="user-id">
                <div class="form-group">
                    <label>–õ–æ–≥–∏–Ω</label>
                    <input type="text" id="user-username" required>
                </div>
                <div class="form-group">
                    <label>–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="user-password" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ">
                </div>
                <div class="form-group">
                    <label>–ü–æ–ª–Ω–æ–µ –∏–º—è</label>
                    <input type="text" id="user-fullname" required>
                </div>
                <div class="form-group">
                    <label>–†–æ–ª—å</label>
                    <select id="user-role" required>
                        <option value="worker">–†–∞–±–æ—á–∏–π</option>
                        <option value="master">–ú–∞—Å—Ç–µ—Ä</option>
                        <option value="dispatcher">–î–∏—Å–ø–µ—Ç—á–µ—Ä</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal('user')">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Equipment Modal -->
    <div id="equipment-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="equipment-modal-title">–î–æ–±–∞–≤–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</h2>
                <span class="close" onclick="closeModal('equipment')">&times;</span>
            </div>
            <form id="equipment-form" onsubmit="saveEquipment(event)">
                <input type="hidden" id="equipment-id">
                <div class="form-group">
                    <label>–ö–æ–¥</label>
                    <input type="text" id="equipment-code" required placeholder="CNC-001">
                </div>
                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" id="equipment-name" required>
                </div>
                <div class="form-group">
                    <label>–ù–æ–º–µ—Ä —Ü–µ—Ö–∞</label>
                    <input type="number" id="equipment-shop" placeholder="1">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal('equipment')">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Request Edit Modal -->
    <div id="request-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞—è–≤–∫—É</h2>
                <span class="close" onclick="closeModal('request')">&times;</span>
            </div>
            <form id="request-form" onsubmit="saveRequest(event)">
                <input type="hidden" id="request-id">
                <div class="form-group">
                    <label>–°—Ç–∞—Ç—É—Å</label>
                    <select id="request-status" required>
                        <option value="New">–ù–æ–≤–∞—è</option>
                        <option value="Assigned">–ù–∞–∑–Ω–∞—á–µ–Ω–∞</option>
                        <option value="In Progress">–í —Ä–∞–±–æ—Ç–µ</option>
                        <option value="Completed">–í—ã–ø–æ–ª–Ω–µ–Ω–∞</option>
                        <option value="Denied">–û—Ç–∫–ª–æ–Ω–µ–Ω–∞</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–ú–∞—Å—Ç–µ—Ä</label>
                    <select id="request-technician">
                        <option value="">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal('request')">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });
        
        // Status message
        function showStatus(msg, isError = false) {
            const el = document.getElementById('status-msg');
            el.textContent = msg;
            el.className = 'status-msg ' + (isError ? 'error' : 'success');
            setTimeout(() => el.className = 'status-msg', 3000);
        }
        
        // Filter table
        function filterTable(tableId, query) {
            const rows = document.querySelectorAll(`#${tableId} tbody tr`);
            query = query.toLowerCase();
            rows.forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(query) ? '' : 'none';
            });
        }
        
        // Modal functions
        function openModal(type) {
            document.getElementById(`${type}-modal`).classList.add('show');
            if (type === 'user') {
                document.getElementById('user-modal-title').textContent = '–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
                document.getElementById('user-form').reset();
                document.getElementById('user-id').value = '';
            } else if (type === 'equipment') {
                document.getElementById('equipment-modal-title').textContent = '–î–æ–±–∞–≤–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ';
                document.getElementById('equipment-form').reset();
                document.getElementById('equipment-id').value = '';
            }
        }
        
        function closeModal(type) {
            document.getElementById(`${type}-modal`).classList.remove('show');
        }
        
        // ==================
        // USERS
        // ==================
        async function loadUsers() {
            const res = await fetch('/admin/users');
            const users = await res.json();
            const tbody = document.querySelector('#users-table tbody');
            tbody.innerHTML = users.map(u => `
                <tr>
                    <td>${u.id}</td>
                    <td>${u.username}</td>
                    <td>${u.full_name}</td>
                    <td><span class="badge badge-${u.role}">${u.role}</span></td>
                    <td class="actions">
                        <button class="btn btn-warning btn-sm" onclick="editUser(${u.id})">‚úèÔ∏è</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteUser(${u.id})">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
            
            // Update masters dropdown
            const select = document.getElementById('request-technician');
            select.innerHTML = '<option value="">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</option>' + 
                users.filter(u => u.role === 'master').map(u => 
                    `<option value="${u.id}">${u.full_name}</option>`
                ).join('');
        }
        
        function editUser(id) {
            fetch(`/admin/users`).then(r => r.json()).then(users => {
                const u = users.find(x => x.id === id);
                document.getElementById('user-modal-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
                document.getElementById('user-id').value = u.id;
                document.getElementById('user-username').value = u.username;
                document.getElementById('user-fullname').value = u.full_name;
                document.getElementById('user-role').value = u.role;
                document.getElementById('user-password').value = '';
                document.getElementById('user-modal').classList.add('show');
            });
        }
        
        async function saveUser(e) {
            e.preventDefault();
            const id = document.getElementById('user-id').value;
            const data = {
                username: document.getElementById('user-username').value,
                password: document.getElementById('user-password').value,
                full_name: document.getElementById('user-fullname').value,
                role: document.getElementById('user-role').value
            };
            
            const res = await fetch(id ? `/admin/users/${id}` : '/admin/users', {
                method: id ? 'PUT' : 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            if (res.ok) {
                showStatus(id ? '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω');
                closeModal('user');
                loadUsers();
            } else {
                const err = await res.json();
                showStatus(err.error || '–û—à–∏–±–∫–∞', true);
            }
        }
        
        async function deleteUser(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return;
            const res = await fetch(`/admin/users/${id}`, {method: 'DELETE'});
            if (res.ok) {
                showStatus('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω');
                loadUsers();
            } else {
                showStatus('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', true);
            }
        }
        
        // ==================
        // EQUIPMENT
        // ==================
        async function loadEquipment() {
            const res = await fetch('/admin/equipment');
            const items = await res.json();
            const tbody = document.querySelector('#equipment-table tbody');
            tbody.innerHTML = items.map(e => `
                <tr>
                    <td>${e.id}</td>
                    <td>${e.code}</td>
                    <td>${e.name}</td>
                    <td>${e.shop_id || '-'}</td>
                    <td class="actions">
                        <button class="btn btn-warning btn-sm" onclick="editEquipment(${e.id})">‚úèÔ∏è</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteEquipment(${e.id})">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function editEquipment(id) {
            fetch(`/admin/equipment`).then(r => r.json()).then(items => {
                const e = items.find(x => x.id === id);
                document.getElementById('equipment-modal-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ';
                document.getElementById('equipment-id').value = e.id;
                document.getElementById('equipment-code').value = e.code;
                document.getElementById('equipment-name').value = e.name;
                document.getElementById('equipment-shop').value = e.shop_id || '';
                document.getElementById('equipment-modal').classList.add('show');
            });
        }
        
        async function saveEquipment(e) {
            e.preventDefault();
            const id = document.getElementById('equipment-id').value;
            const data = {
                code: document.getElementById('equipment-code').value,
                name: document.getElementById('equipment-name').value,
                shop_id: parseInt(document.getElementById('equipment-shop').value) || null
            };
            
            const res = await fetch(id ? `/admin/equipment/${id}` : '/admin/equipment', {
                method: id ? 'PUT' : 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            if (res.ok) {
                showStatus(id ? '–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ' : '–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ');
                closeModal('equipment');
                loadEquipment();
            } else {
                const err = await res.json();
                showStatus(err.error || '–û—à–∏–±–∫–∞', true);
            }
        }
        
        async function deleteEquipment(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ?')) return;
            const res = await fetch(`/admin/equipment/${id}`, {method: 'DELETE'});
            if (res.ok) {
                showStatus('–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ');
                loadEquipment();
            } else {
                showStatus('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', true);
            }
        }
        
        // ==================
        // REQUESTS
        // ==================
        async function loadRequests() {
            const res = await fetch('/admin/requests');
            const items = await res.json();
            const tbody = document.querySelector('#requests-table tbody');
            const statusMap = {'New': 'new', 'Assigned': 'assigned', 'In Progress': 'inprogress', 'Completed': 'completed', 'Denied': 'denied'};
            tbody.innerHTML = items.map(r => `
                <tr>
                    <td>${r.id}</td>
                    <td>${r.created_at ? new Date(r.created_at).toLocaleString('ru') : '-'}</td>
                    <td>${r.author_name || '-'}</td>
                    <td title="${r.description}">${r.description?.substring(0, 50) || '-'}${r.description?.length > 50 ? '...' : ''}</td>
                    <td>${r.technician_name || '-'}</td>
                    <td><span class="badge badge-${statusMap[r.status] || 'new'}">${r.status}</span></td>
                    <td class="actions">
                        <button class="btn btn-warning btn-sm" onclick="editRequest(${r.id})">‚úèÔ∏è</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteRequest(${r.id})">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function editRequest(id) {
            fetch(`/admin/requests`).then(r => r.json()).then(items => {
                const req = items.find(x => x.id === id);
                document.getElementById('request-id').value = req.id;
                document.getElementById('request-status').value = req.status;
                document.getElementById('request-technician').value = req.technician_id || '';
                document.getElementById('request-modal').classList.add('show');
            });
        }
        
        async function saveRequest(e) {
            e.preventDefault();
            const id = document.getElementById('request-id').value;
            const data = {
                status: document.getElementById('request-status').value,
                technician_id: document.getElementById('request-technician').value || null
            };
            
            const res = await fetch(`/admin/requests/${id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            if (res.ok) {
                showStatus('–ó–∞—è–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
                closeModal('request');
                loadRequests();
            } else {
                const err = await res.json();
                showStatus(err.error || '–û—à–∏–±–∫–∞', true);
            }
        }
        
        async function deleteRequest(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É?')) return;
            const res = await fetch(`/admin/requests/${id}`, {method: 'DELETE'});
            if (res.ok) {
                showStatus('–ó–∞—è–≤–∫–∞ —É–¥–∞–ª–µ–Ω–∞');
                loadRequests();
            } else {
                showStatus('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', true);
            }
        }
        
        async function resetRequests() {
            const res = await fetch('/admin/reset_requests', {method: 'POST'});
            const data = await res.json();
            if (res.ok) {
                showStatus(data.message);
                loadRequests();
            } else {
                showStatus(data.error || '–û—à–∏–±–∫–∞', true);
            }
        }
        
        // Initial load
        loadUsers();
        loadEquipment();
        loadRequests();
    </script>
</body>
</html>
